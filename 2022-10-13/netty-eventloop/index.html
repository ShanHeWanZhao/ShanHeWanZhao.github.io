<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">
  <meta name="msvalidate.01" content="179F7AB6AAB937D65F84E184278E61E9">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.36/fancybox/fancybox.css" integrity="sha256-zM8WXtG4eUn7dKKNMTuoWZub++VnSfaOpA/8PJfvTBo=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.shanzhao.site","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="​	 基于Netty 4.1.34版本，分析了 Netty 中NIO相关的 EventLoopGroup 与 EventLoop 的核心功能和实现原理，重点涵盖了JDK Selector 的性能瓶颈与 Netty 优化策略、事件循环线程的阻塞与唤醒机制（含空轮询 Bug 修复方案）、IO 事件与任务调度细节，并配套流程图直观展示 EventLoop 工作流程">
<meta property="og:type" content="article">
<meta property="og:title" content="Netty（三） — EventLoopGroup和EventLoop">
<meta property="og:url" content="https://blog.shanzhao.site/2022-10-13/netty-eventloop/index.html">
<meta property="og:site_name" content="Reef&#39;s Blog">
<meta property="og:description" content="​	 基于Netty 4.1.34版本，分析了 Netty 中NIO相关的 EventLoopGroup 与 EventLoop 的核心功能和实现原理，重点涵盖了JDK Selector 的性能瓶颈与 Netty 优化策略、事件循环线程的阻塞与唤醒机制（含空轮询 Bug 修复方案）、IO 事件与任务调度细节，并配套流程图直观展示 EventLoop 工作流程">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img.shanzhao.site/file/1755176323750_netty-eventloop-process.png">
<meta property="article:published_time" content="2022-10-13T15:18:03.000Z">
<meta property="article:modified_time" content="2022-10-16T11:52:09.000Z">
<meta property="article:author" content="reef">
<meta property="article:tag" content="NIO">
<meta property="article:tag" content="事件循环">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.shanzhao.site/file/1755176323750_netty-eventloop-process.png">


<link rel="canonical" href="https://blog.shanzhao.site/2022-10-13/netty-eventloop/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.shanzhao.site/2022-10-13/netty-eventloop/","path":"2022-10-13/netty-eventloop/","title":"Netty（三） — EventLoopGroup和EventLoop"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Netty（三） — EventLoopGroup和EventLoop | Reef's Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.36/fancybox/fancybox.umd.js" integrity="sha256-hiUEBwFEpLF6DlB8sGXlKo4kPZ46Ui4qGpd0vrVkOm4=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>




  <script src="/js/third-party/fancybox.js" defer></script>



  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reef's Blog" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reef's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">hello world</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-rss订阅"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>RSS订阅</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#EventLoopGroup"><span class="nav-number">1.</span> <span class="nav-text">EventLoopGroup</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E5%8F%82%E6%95%B0"><span class="nav-number">1.1.</span> <span class="nav-text">关键参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EventLoop"><span class="nav-number">2.</span> <span class="nav-text">EventLoop</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Selector%E4%BC%98%E5%8C%96"><span class="nav-number">2.1.</span> <span class="nav-text">Selector优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">2.1.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E5%8C%96"><span class="nav-number">2.1.2.</span> <span class="nav-text">优化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Channel%E6%B3%A8%E5%86%8C"><span class="nav-number">2.2.</span> <span class="nav-text">Channel注册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="nav-number">2.3.</span> <span class="nav-text">事件循环</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E9%98%BB%E5%A1%9E%E5%92%8C%E5%94%A4%E9%86%92"><span class="nav-number">2.3.1.</span> <span class="nav-text">线程的阻塞和唤醒</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%98%BB%E5%A1%9Eselect"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">阻塞select</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%94%A4%E9%86%92"><span class="nav-number">2.3.1.2.</span> <span class="nav-text">唤醒</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IO%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86"><span class="nav-number">2.3.2.</span> <span class="nav-text">IO事件处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E5%92%8C%E5%BB%B6%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86"><span class="nav-number">2.3.3.</span> <span class="nav-text">普通和延时任务处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#shutdown%E6%A3%80%E6%B5%8B"><span class="nav-number">2.3.4.</span> <span class="nav-text">shutdown检测</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">2.4.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">3.</span> <span class="nav-text">事件循环流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5"><span class="nav-number">4.</span> <span class="nav-text">相关链接</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="reef"
      src="/images/favicon.png">
  <p class="site-author-name" itemprop="name">reef</p>
  <div class="site-description" itemprop="description">Chasing freedom where the horizon meets the sea</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">52</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ShanHeWanZhao" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ShanHeWanZhao" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:shanzhao.rd@gmail.com" title="E-Mail → mailto:shanzhao.rd@gmail.com" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.shanzhao.site/2022-10-13/netty-eventloop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon.png">
      <meta itemprop="name" content="reef">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reef's Blog">
      <meta itemprop="description" content="Chasing freedom where the horizon meets the sea">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Netty（三） — EventLoopGroup和EventLoop | Reef's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Netty（三） — EventLoopGroup和EventLoop
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-10-13 23:18:03" itemprop="dateCreated datePublished" datetime="2022-10-13T23:18:03+08:00">2022-10-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-10-16 19:52:09" itemprop="dateModified" datetime="2022-10-16T19:52:09+08:00">2022-10-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Netty/" itemprop="url" rel="index"><span itemprop="name">Netty</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>17 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>​	 基于Netty 4.1.34版本，分析了 Netty 中NIO相关的 <strong>EventLoopGroup</strong> 与 <strong>EventLoop</strong> 的核心功能和实现原理，重点涵盖了<strong>JDK Selector 的性能瓶颈与 Netty 优化策略</strong>、<strong>事件循环线程的阻塞与唤醒机制（含空轮询 Bug 修复方案）、IO 事件与任务调度细节</strong>，并配套流程图直观展示 EventLoop 工作流程</p>
<span id="more"></span>

<h2 id="EventLoopGroup"><a href="#EventLoopGroup" class="headerlink" title="EventLoopGroup"></a>EventLoopGroup</h2><p>在 NIO 模型中，Netty 默认的实现是 <strong><code>NioEventLoopGroup</code><strong>，它是 <strong><code>NioEventLoop</code></strong> 的管理组件，本质上就是一个</strong>线程池</strong>（每个线程绑定一个 EventLoop）。它实现的核心接口 <code>EventExecutorGroup</code>，具备以下特点：</p>
<ul>
<li><strong>投递普通任务</strong>：提交Runnable到指定的 EventLoop 执行</li>
<li><strong>投递延时任务到EventLoop中执行</strong></li>
<li><strong>轮询选择 EventLoop</strong>：通过内部的 <strong>EventExecutorChooser</strong>，为新注册的 Channel 分配下一个可用的 EventLoop</li>
</ul>
<p><strong>职责总结</strong>：</p>
<blockquote>
<p>​	EventLoopGroup 只负责：<strong>维护 EventLoop 数组</strong> → <strong>轮询分配Runnable &#x2F; Channel</strong> → <strong>交给目标 EventLoop 线程处理</strong><br>​	具体的 IO 读写、任务执行和定时任务调度由 EventLoop 自己完成。</p>
</blockquote>
<h3 id="关键参数"><a href="#关键参数" class="headerlink" title="关键参数"></a>关键参数</h3><pre class="line-numbers language-ini"><code class="language-ini"><span class="token constant">io.netty.eventLoopThreads</span> <span class="token attr-value"><span class="token punctuation">=</span> CPU核心数 * 2</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>通过NioEventLoopGroup的构造方法可以看到，默认线程数为<strong>CPU核心数 * 2</strong>，可以通过上面的<strong>系统参数</strong>设置</p>
<h2 id="EventLoop"><a href="#EventLoop" class="headerlink" title="EventLoop"></a>EventLoop</h2><p>​	<code>EventLoop</code> 是 Netty 最核心的组件，NIO 模式下的实现类为 <strong><code>NioEventLoop</code><strong>。 每个 <code>NioEventLoop</code> 在实例化时都会创建一个 <code>Selector</code>，所有注册到该 <code>NioEventLoop</code> 的 <code>Channel</code> 都会绑定到它的内部 <code>Selector</code>；并且只会启动 <strong>一个专属线程</strong>，该线程循环执行三类任务（</strong>事件循环机制</strong>）：</p>
<ol>
<li><strong>处理 <code>Selector</code> 上已就绪的 IO 事件</strong></li>
<li><strong>执行普通任务队列中的 Runnable</strong></li>
<li><strong>执行延时任务队列中到期的定时任务</strong></li>
</ol>
<h3 id="Selector优化"><a href="#Selector优化" class="headerlink" title="Selector优化"></a>Selector优化</h3><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>​	调用 JDK <code>Selector#select</code> 系列方法时，已就绪的 IO 事件会被封装成 <code>SelectionKey</code> 对象，并存放到 <code>sun.nio.ch.SelectorImpl#selectedKeys</code> 集合中，同时通过 <code>publicSelectedKeys</code> 暴露给外部遍历。这两个集合都是 <strong>HashSet</strong>，在高频 IO 场景下存在几个性能问题：</p>
<ul>
<li><p><strong>增删开销</strong>：<code>add</code>、<code>remove</code> 操作不是绝对 O(1)时间复杂度，存在hash冲突，且可能<strong>触发链表&#x2F;红黑树调整</strong></p>
</li>
<li><p><strong>GC 压力</strong>：操作过程中需要<strong>频繁地创建一些辅助的数据结构（Node, TreeNode等）</strong></p>
</li>
<li><p><strong>遍历效率</strong>：HashSet 的迭代器访问模式不够连续（链表或红黑树），CPU 缓存命中率低</p>
</li>
</ul>
<h4 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h4><p>​	Netty 在 <code>NioEventLoop</code> 构造时会通过 <code>openSelector</code> 方法反射替换 <code>SelectorImpl</code> 的 <code>selectedKeys</code> 和 <code>publicSelectedKeys</code>，其实现为SelectedSelectionKeySet，具有如下特征：</p>
<ul>
<li><p><strong>数组实现</strong>：<strong>不会有其他辅助的数据结构，减少GC</strong>。<strong>且是绝对的 O(1) 插入（直接放入数组末尾），没有哈希运算</strong></p>
</li>
<li><p><strong>不支持 remove</strong>：因为一次事件循环中 Netty 会处理完所有就绪事件，所以SelectedSelectionKeySetSelector在select前都会调用reset来清空数组，避免了逐个删除的开销</p>
</li>
<li><p><strong>遍历时顺序访问数组</strong>，CPU 缓存友好</p>
</li>
</ul>
<p>​	这种替换极大减少了 Selector 就绪事件处理过程中的 <strong>对象创建、Hash 运算和结构调整</strong>，在高并发场景下性能收益显著</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// SelectedSelectionKeySetSelector包装后的Selector，每次调用select时都进行reset</span>
<span class="token keyword">private</span> Selector selector<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// JDK原生的Selector实现</span>
<span class="token keyword">private</span> Selector unwrappedSelector<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// sun.nio.ch.SelectorImpl内部字段selectedKeys和publicSelectedKeys的替代品</span>
<span class="token keyword">private</span> SelectedSelectionKeySet selectedKeys<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">final</span> SelectorProvider provider<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Channel注册"><a href="#Channel注册" class="headerlink" title="Channel注册"></a>Channel注册</h3><p>​	<code>EventLoopGroup#register</code> 用于将 <code>Channel</code> 绑定到当前 <code>EventLoop</code> 线程，核心调用链如下</p>
<blockquote>
<ol>
<li>io.netty.channel.SingleThreadEventLoop#register(io.netty.channel.Channel)</li>
<li>io.netty.channel.AbstractChannel.AbstractUnsafe#register</li>
<li>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</li>
<li>io.netty.channel.nio.AbstractNioChannel#doRegister</li>
</ol>
</blockquote>
<p>​	在 <code>AbstractNioChannel#doRegister</code> 中，<code>Channel</code> 会被注册到当前 <code>EventLoop</code> 的 <code>Selector</code> 上（此时<strong>仅完成绑定，并未关注任何事件</strong>）。<strong>自此，<code>Channel</code> 生命周期中的所有 IO 事件都将由该 <code>EventLoop</code> 线程独立处理</strong></p>
<h3 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h3><p>​	EventLoop 线程是 Netty 的核心执行单元，不仅负责 <strong>Channel 的 I&#x2F;O 事件处理</strong>，还实现了 <code>ScheduledExecutorService</code> 接口，可同时处理 <strong>延时任务</strong> 与 <strong>普通 Runnable 任务</strong>。</p>
<p>​	EventLoop线程采用 <strong>懒启动</strong> 机制：只有首次调用 <code>execute()</code> 提交任务时，才会通过 <strong>CAS 启动专属线程</strong>，并在 <code>io.netty.channel.nio.NioEventLoop#run</code> 方法中进入循环</p>
<h4 id="线程的阻塞和唤醒"><a href="#线程的阻塞和唤醒" class="headerlink" title="线程的阻塞和唤醒"></a>线程的阻塞和唤醒</h4><p>事件循环开始时，会先<strong>根据当前任务队列状态决定本轮的 <code>select</code> 策略，</strong>具体逻辑如下：</p>
<ul>
<li><strong>有任务</strong> → 调用 <code>selectNow()</code>，立即返回已就绪事件数（<strong>非阻塞</strong>）。提高任务响应速度</li>
<li><strong>无任务</strong> → 返回 <code>SelectStrategy.SELECT</code>，随后<strong>调用阻塞的 <code>select()</code> 等待 IO 事件</strong>。减少CPU空转</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>selectStrategy<span class="token punctuation">.</span><span class="token function">calculateStrategy</span><span class="token punctuation">(</span>selectNowSupplier<span class="token punctuation">,</span> <span class="token function">hasTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> SelectStrategy<span class="token punctuation">.</span>CONTINUE<span class="token operator">:</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> SelectStrategy<span class="token punctuation">.</span>BUSY_WAIT<span class="token operator">:</span>
            <span class="token comment" spellcheck="true">// fall-through to SELECT since the busy-wait is not supported with NIO</span>

        <span class="token comment" spellcheck="true">// ============= NIO只会走如下两种case ===================</span>
        <span class="token keyword">case</span> SelectStrategy<span class="token punctuation">.</span>SELECT<span class="token operator">:</span>
            <span class="token function">select</span><span class="token punctuation">(</span>wakenUp<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token keyword">if</span> <span class="token punctuation">(</span>wakenUp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                selector<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment" spellcheck="true">// 其他策略不做处理</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">rebuildSelector0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">handleLoopException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="阻塞select"><a href="#阻塞select" class="headerlink" title="阻塞select"></a>阻塞select</h5><p>核心方法NioEventLoop#select代码如下，总结下其主要功能：</p>
<ol>
<li><p>超时阻塞Selector</p>
<blockquote>
<p>​	首先会根据<strong>最近的延时任务来算超时时间（没任务就默认1秒）</strong>，保证不会因为一直堵在那里</p>
</blockquote>
</li>
<li><p>解决<a target="_blank" rel="noopener external nofollow noreferrer" href="https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6670302">早期JDK NIO的空轮询bug</a></p>
<blockquote>
<p>​	早期JDK（6,7,8） NIO的Selector在<strong>调用超时select方法时，可能触发空轮询的bug，即立即返回，造成CPU的空转，利用率飙升</strong></p>
<p>​	Netty 为了解决这个问题，会对连续调用 <code>select()</code> 过程中<strong>空返回的次数进行计数</strong>。如果<strong>连续超过 512 次（io.netty.selectorAutoRebuildThreshold），说明可能触发了空轮询的 bug</strong>。此时，Netty 会<strong>重建一个新的 Selector，并将之前注册的所有 Channel 迁移到新 Selector 上，类似于给 Selector 做一次重启</strong>，避免空轮询导致的 CPU 空转</p>
</blockquote>
</li>
<li><p><strong>满足以下任意条件时退出阻塞循环，开始处理事件和任务</strong></p>
<blockquote>
<ol>
<li>有<strong>IO事件准备好</strong></li>
<li><strong>外部线程触发的唤醒</strong>（oldWakenUp为true）</li>
<li><strong>内部被标记为已唤醒</strong>（wakenUp标志）</li>
<li><strong>存在待执行的普通Runnable任务</strong></li>
<li><strong>存在已到期的延时任务</strong></li>
</ol>
</blockquote>
</li>
<li><p>中断响应</p>
<blockquote>
<p>如果当前线程被中断，立马退出阻塞，保证能及时响应中断信号，不被卡住</p>
</blockquote>
</li>
</ol>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> oldWakenUp<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    Selector selector <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 本次循环调用select的次数统计，用于检测过早返回现象（即select无效唤醒）</span>
        <span class="token keyword">int</span> selectCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> currentTimeNanos <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// select阻塞截止时间（deadLine）</span>
        <span class="token comment" spellcheck="true">// 1. 取决于最近的定时任务时间，保证select不会阻塞超过这段时间，避免错过定时任务</span>
        <span class="token comment" spellcheck="true">// 2. 没有定时任务则默认为1秒后</span>
        <span class="token keyword">long</span> selectDeadLineNanos <span class="token operator">=</span> currentTimeNanos <span class="token operator">+</span> <span class="token function">delayNanos</span><span class="token punctuation">(</span>currentTimeNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 定时检测Selector的时间</span>
            <span class="token keyword">long</span> timeoutMillis <span class="token operator">=</span> <span class="token punctuation">(</span>selectDeadLineNanos <span class="token operator">-</span> currentTimeNanos <span class="token operator">+</span> 500000L<span class="token punctuation">)</span> <span class="token operator">/</span> 1000000L<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 超时判断：如果截止时间已到或超时。保证至少调用了一次select再跳出循环</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutMillis <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>selectCnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    selector<span class="token punctuation">.</span><span class="token function">selectNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    selectCnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// 若有待执行任务且未被唤醒，立即非阻塞selectNow再跳出循环，避免长时间阻塞</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> wakenUp<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                selector<span class="token punctuation">.</span><span class="token function">selectNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                selectCnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 调用阻塞select，最多阻塞timeoutMillis毫秒，等待IO事件或被唤醒</span>
            <span class="token keyword">int</span> selectedKeys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            selectCnt<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/*
             * 检测是否满足退出阻塞循环条件：
             * 1. 有IO事件准备好
             * 2. 外部线程触发的唤醒（oldWakenUp为true）
             * 3. 内部被标记为已唤醒（wakenUp标志）
             * 4. 存在待执行的普通任务
             * 5. 存在已到期的定时任务
             */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedKeys <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> oldWakenUp <span class="token operator">||</span> wakenUp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hasTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hasScheduledTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 中断支持，跳出循环</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                selectCnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">long</span> time <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">-</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeoutMillis<span class="token punctuation">)</span> <span class="token operator">>=</span> currentTimeNanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// select本次阻塞时长正常，超过了预期timeout</span>
                <span class="token comment" spellcheck="true">// 说明未出现select过早返回（空轮询）问题，重置计数器避免误判</span>
                selectCnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>SELECTOR_AUTO_REBUILD_THRESHOLD <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                    selectCnt <span class="token operator">>=</span> SELECTOR_AUTO_REBUILD_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token comment" spellcheck="true">// select连续过早返回次数超过了阈值（默认512次），则重建Selector以避免CPU空转导致的死循环</span>
                selector <span class="token operator">=</span> <span class="token function">selectRebuildSelector</span><span class="token punctuation">(</span>selectCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                selectCnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            currentTimeNanos <span class="token operator">=</span> time<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 当select连续过早返回次数过多，打印调试日志，方便问题排查</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>selectCnt <span class="token operator">></span> MIN_PREMATURE_SELECTOR_RETURNS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Selector.select() returned prematurely {} times in a row for Selector {}."</span><span class="token punctuation">,</span>selectCnt <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// debug日志</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="唤醒"><a href="#唤醒" class="headerlink" title="唤醒"></a>唤醒</h5><p>​	<code>addTaskWakesUp</code> 与 <code>wakenUp</code> 都用于控制 EventLoop 的唤醒逻辑。当<strong>主线程通过 <code>execute()</code> 向 EventLoop 提交 非 NonWakeupRunnable</strong> 任务时：</p>
<ol>
<li>如果 <code>addTaskWakesUp</code> 为 <code>false</code>（如 NioEventLoop），表示仅向任务队列添加任务不会自动唤醒，需要显式唤醒</li>
<li>此时会<strong>尝试将 <code>wakenUp</code> 从 <code>false</code> 设置为 <code>true</code>，成功则调用 <code>Selector#wakeup()</code>，唤醒阻塞在 <code>select()</code> 上的 EventLoop 线程</strong></li>
<li>被唤醒的线程会从阻塞中恢复，继续执行包括普通 Runnable 在内的后续任务</li>
</ol>
<p>注意：<strong>定时任务在投递时会被包装为普通 <code>Runnable</code>，由该 <code>Runnable</code> 负责向延时队列提交任务，因此同样具备触发 <code>wakeUp</code> 的能力</strong></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 *
 * 1. addTaskWakesUp
 *    表示向 taskQueue 添加任务时，是否能自动唤醒 EventLoop 线程
 *    - true  ：添加任务即可唤醒线程（由任务队列本身负责唤醒，例如 DefaultEventLoop 使用的阻塞队列）
 *    - false ：添加任务不会自动唤醒，需要手动调用 wakeup()。如 NioEventLoop，线程阻塞在 Selector#select，而不是 taskQueue
 * 
 *  NioEventLoop设为了false
 *
 */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> addTaskWakesUp<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/**
 *  一个原子标志，用于避免重复调用 Selector#wakeup()
 *    - 当需要唤醒时，如果之前未设置为 true，则设置为 true 并实际唤醒
 *    - 事件循环开始时会重置为 false
 */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> AtomicBoolean wakenUp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="IO事件处理"><a href="#IO事件处理" class="headerlink" title="IO事件处理"></a>IO事件处理</h4><p>​	<code>NioEventLoop</code> 既能管 <code>SocketChannel</code>，也能管 <code>ServerSocketChannel</code>。<br> 所以它的 <code>processSelectedKey</code> 方法是通用的，会去检查四种事件类型，但实际上<strong>每个 Channel 只会注册自己感兴趣的事件</strong>，因此一个 <code>SelectionKey</code> 只会触发自己该处理的那几种：</p>
<ul>
<li><strong>SocketChannel</strong><ul>
<li><strong>OP_CONNECT</strong>：确保连接建立，并触发 Netty 的 <code>ChannelActive</code> 事件</li>
<li><strong>OP_WRITE</strong>：把发送缓冲区里的数据刷出去</li>
<li><strong>OP_READ</strong>：从Channel里读数据</li>
</ul>
</li>
<li><strong>ServerSocketChannel</strong><ul>
<li><strong>OP_ACCEPT</strong>：接收新连接，并把它注册到对应的 <code>EventLoop</code> 上</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processSelectedKey</span><span class="token punctuation">(</span>SelectionKey k<span class="token punctuation">,</span> AbstractNioChannel ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ... 省略SelectionKey无效的处理</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// bitmask数据结构，检测每一位可知对于的事件是否就绪</span>
        <span class="token keyword">int</span> readyOps <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 先处理 OP_CONNECT：确保 TCP 连接已经完成</span>
        <span class="token comment" spellcheck="true">// SocketChannel专属：SocketChannel在connect服务端时，如果未及时连接成功，才注册OP_CONNECT事件。代码在NioSocketChannel.doConnect里</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> SelectionKey<span class="token punctuation">.</span>OP_CONNECT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 取消OP_CONNECT的监听（避免JDK的OP_CONNECT未取消导致 select() 永远立即返回的bug）</span>
            <span class="token keyword">int</span> ops <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ops <span class="token operator">&amp;=</span> <span class="token operator">~</span>SelectionKey<span class="token punctuation">.</span>OP_CONNECT<span class="token punctuation">;</span>
            k<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>

            unsafe<span class="token punctuation">.</span><span class="token function">finishConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 处理SocketChannel的OP_WRITE事件：尝试发送积压的数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> SelectionKey<span class="token punctuation">.</span>OP_WRITE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ch<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forceFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 特殊情况：JDK 的 bug 可能导致 readyOps == 0，但实际上还是有事件需要处理</span>
        <span class="token comment" spellcheck="true">// OP_READ(SocketChannel)：从 socket 读取数据</span>
        <span class="token comment" spellcheck="true">// OP_ACCEPT(ServerSocketChannel)：接收新连接并注册到 EventLoop</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token punctuation">(</span>SelectionKey<span class="token punctuation">.</span>OP_READ <span class="token operator">|</span> SelectionKey<span class="token punctuation">.</span>OP_ACCEPT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> readyOps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            unsafe<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        unsafe<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="普通和延时任务处理"><a href="#普通和延时任务处理" class="headerlink" title="普通和延时任务处理"></a>普通和延时任务处理</h4><p>​	每个 EventLoop 都有自己的<strong>普通任务队列</strong>和<strong>延时任务队列</strong>，它们在一次循环中能占用的执行时间由 <code>ioRatio</code> 控制。其表示 <strong>IO 处理时间在一次循环中的比例</strong>，<strong>默认 50%，也就是 IO 时间 &#x3D; 任务执行时间</strong></p>
<p>​	<strong>为了减少 <code>nanoTime()</code> 的性能开销，Netty 会</strong>每执行 64 （硬编码的）个任务<strong>才检查一次是否超时。所以，如果某个 Runnable 本身执行很慢，就会拖长任务阶段的时间，从而</strong>影响 IO 事件的及时处理</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * IO 事件处理时间占总循环时间的比例（百分比）
 * 
 * EventLoop 既要处理 Channel 的 IO 事件，也要执行普通任务（Runnable）和定时任务，
 * 这个比例决定了一次循环中 IO 事件和任务执行的时间分配，默认 50:50
 */</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> ioRatio <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 当前EventLoop线程的普通任务队列（调用 execute() 提交的 Runnable 会进入这里）</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> Queue<span class="token operator">&lt;</span>Runnable<span class="token operator">></span> taskQueue<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 当前EventLoop线程的定时任务队列（小顶堆），定时任务会封装成 ScheduledFutureTask 放在这里</span>
PriorityQueue<span class="token operator">&lt;</span>ScheduledFutureTask<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> scheduledTaskQueue<span class="token punctuation">;</span>

<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">runAllTasks</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeoutNanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 把已到期的定时任务转移到普通任务队列</span>
    <span class="token function">fetchFromScheduledTaskQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Runnable task <span class="token operator">=</span> <span class="token function">pollTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">afterRunningAllTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token keyword">long</span> deadline <span class="token operator">=</span> ScheduledFutureTask<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timeoutNanos<span class="token punctuation">;</span>
    <span class="token keyword">long</span> runTasks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> lastExecutionTime<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 安全执行任务（捕获并吞掉 Throwable，防止任务异常影响循环）</span>
        <span class="token function">safeExecute</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

        runTasks<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 每执行 64 个任务检查一次是否超时（减少调用 nanoTime() 的频率，避免性能开销）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>runTasks <span class="token operator">&amp;</span> <span class="token number">0x3F</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lastExecutionTime <span class="token operator">=</span> ScheduledFutureTask<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastExecutionTime <span class="token operator">>=</span> deadline<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 超时就结束任务执行</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        task <span class="token operator">=</span> <span class="token function">pollTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 没有任务了，直接跳出循环</span>
            lastExecutionTime <span class="token operator">=</span> ScheduledFutureTask<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// after hook：即执行tailTasks里的任务</span>
    <span class="token function">afterRunningAllTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lastExecutionTime <span class="token operator">=</span> lastExecutionTime<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="shutdown检测"><a href="#shutdown检测" class="headerlink" title="shutdown检测"></a>shutdown检测</h4><p>​	每轮循环结束时都会检测 <code>isShuttingDown()</code>，以实现 <strong>优雅关闭</strong>。其主要做了如下几件事：</p>
<ul>
<li><strong>关闭当前 EventLoop 管理的所有 Channel</strong></li>
<li>取消所有定时任务</li>
<li>执行剩余普通任务，无任务时运行 shutdownHooks</li>
<li>满足静默期或超时条件后才退出线程</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>​	综合上面的分析，可发现Netty 在 <code>NioEventLoop</code> 上做了不少魔改和优化，不仅绕开了 JDK NIO 的一些坑，还顺带提升了性能：</p>
<ul>
<li>先说空轮询 bug —— Netty 会监控空轮询的次数，一旦发现触发了这个问题，就直接重建 Selector，彻底规避早期 JDK NIO 里 <code>Selector.select()</code> 立刻返回导致的 CPU 空转</li>
<li>再说提速 —— 它会<strong>用反射把 JDK Selector 内部的关键字段</strong>（<code>selectedKeys</code>、<code>publicSelectedKeys</code>）换成自己优化过的版本，这样不仅处理速度更快，还能明显减少 GC 压力</li>
</ul>
<p>另外，EventLoop 线程跟普通的线程池不一样：</p>
<ul>
<li><strong>每个 EventLoop 都有自己独立的任务队列和延时队列</strong></li>
<li><strong>普通任务的特点是多线程投递、单线程消费</strong>，所以Netty 选择用 <strong>MpscQueue</strong>（多生产者单消费者的无锁队列）来减少竞争和锁开销</li>
<li>延时任务都是 EventLoop 自己投递（外部投递也会包装成普通 Runnable 再投递），这种<strong>单线程生产和消费的场景</strong>下，Netty 就用上了自己实现的 <strong>无锁 <code>DefaultPriorityQueue</code></strong> 来处理延时任务，既简单又高效</li>
</ul>
<h2 id="事件循环流程图"><a href="#事件循环流程图" class="headerlink" title="事件循环流程图"></a>事件循环流程图</h2><img src="https://img.shanzhao.site/file/1755176323750_netty-eventloop-process.png" alt="netty-eventloop-process.png" width=60% height=60%>

<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6670302">早期JDK NIO空轮询bug</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/NIO/" rel="tag"># NIO</a>
              <a href="/tags/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/" rel="tag"># 事件循环</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022-08-16/netty-pipeline-he-handler/" rel="prev" title="Netty（二） — Pipeline和Handler">
                  <i class="fa fa-angle-left"></i> Netty（二） — Pipeline和Handler
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022-11-19/netty-yi-bu-bian-cheng-zhi-promise/" rel="next" title="Netty（四） — 异步编程的实现和思考">
                  Netty（四） — 异步编程的实现和思考 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener external nofollow noreferrer" target="_blank">蜀ICP备2025118748号-1 </a>
  </div>
  <div class="copyright">
    &copy; 2020 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-user"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">reef</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">538k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">16:19</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"ShanHeWanZhao/ShanHeWanZhao.github.io","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js" defer></script>

</body>
</html>
